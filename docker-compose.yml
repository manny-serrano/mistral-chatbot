version: '3.8'

services:
  mistral-app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NETWORK_STORAGE=${NETWORK_STORAGE_PATH:-/tmp}
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://litellm.oit.duke.edu}
      - MILVUS_HOST=milvus
      - MILVUS_PORT=19530
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password123}
      - API_HOST=${API_HOST:-0.0.0.0}
      - API_PORT=${API_PORT:-8000}
      # Network storage optimization
      - NETWORK_STORAGE_PATH=${NETWORK_STORAGE_PATH:-/tmp}
      - MODEL_CACHE_DIR=${MODEL_CACHE_DIR:-/tmp/model-cache}
      - HUGGINGFACE_HUB_CACHE=${HUGGINGFACE_HUB_CACHE:-/tmp/huggingface}
      - HF_HOME=${HF_HOME:-/tmp/huggingface}
      - TRANSFORMERS_CACHE=${TRANSFORMERS_CACHE:-/tmp/transformers}
      - SENTENCE_TRANSFORMERS_HOME=${SENTENCE_TRANSFORMERS_HOME:-/tmp/sentence-transformers}
      - LOW_MEMORY_MODE=${LOW_MEMORY_MODE:-true}
      - USE_SMALLER_MODEL=${USE_SMALLER_MODEL:-false}
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
      # Network storage bind mounts (conditional)
      - type: bind
        source: ${NETWORK_STORAGE_PATH:-./network-storage}/model-cache
        target: /srv/homedir/mistral-app/model-cache
        consistency: cached
      - type: bind
        source: ${LOG_PATH:-./logs}
        target: /srv/homedir/mistral-app/logs
        consistency: cached
    depends_on:
      neo4j:
        condition: service_healthy
      milvus:
        condition: service_healthy
    restart: unless-stopped

  frontend:
    build:
      context: ./Web_UI
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-https://levantai.colab.duke.edu/api-server}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://levantai.colab.duke.edu}
    depends_on:
      mistral-app:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  neo4j:
    image: neo4j:5.15
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=neo4j/password123
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - ./neo4j-graphdatabase:/import
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 7687 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  milvus:
    image: milvusdb/milvus:v2.5.10
    command: ["milvus", "run", "standalone"]
    ports:
      - "19530:19530"
      - "9091:9091"
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    volumes:
      - milvus_data:/var/lib/milvus
    depends_on:
      etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls http://0.0.0.0:2379 --data-dir /etcd
    ports:
      - "2379:2379"
    volumes:
      - etcd_data:/etcd
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    command: minio server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    volumes:
      - minio_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

volumes:
  neo4j_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/neo4j
  neo4j_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOG_PATH:-./logs}/neo4j
  milvus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/milvus
  etcd_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/etcd
  minio_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/minio 