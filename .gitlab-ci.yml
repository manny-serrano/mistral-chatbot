stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # BuildKit will be automatically configured and used for optimized builds

build:
  stage: build
  image: alpine:latest
  script:
    - echo "‚úÖ Build stage completed - ready for deployment"
    - echo "üîß Docker build system will ensure BuildKit is available and configured"
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - echo "üîç Checking VM connectivity..."
    - echo "VM_HOST:$VM_HOST"
    - echo "VM_USER:$VM_USER"
    - echo "Testing network connectivity to IP..."
    - ping -c 3 $VM_HOST
    - echo "‚úÖ VM is reachable via ping"
    - echo "Testing SSH connectivity..."
    - ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes $VM_USER@$VM_HOST "echo 'SSH connection successful'"
    - echo "‚úÖ SSH connection successful"
    - echo "üîç Checking storage before deployment..."
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h /"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h /srv/homedir"
    - echo "üóÇÔ∏è Pre-deployment cache optimization..."
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/docker-build-cache"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/pip-cache"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/npm-cache"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/docker-tmp"
    - echo "üìÅ Creating Docker volume mount directories..."
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/neo4j"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/etcd"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/minio"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/milvus"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/logs/neo4j"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/model-cache"
    - echo "üì¶ Copying optimization scripts..."
    - scp -o StrictHostKeyChecking=no scripts/manage-storage.sh $VM_USER@$VM_HOST:/tmp/
    - scp -o StrictHostKeyChecking=no scripts/optimize-model-storage.sh $VM_USER@$VM_HOST:/tmp/
    - scp -o StrictHostKeyChecking=no scripts/storage-troubleshoot.sh $VM_USER@$VM_HOST:/tmp/
    - scp -o StrictHostKeyChecking=no scripts/fix-docker-volumes.sh $VM_USER@$VM_HOST:/tmp/
    - echo "üîß Copying Apache configuration..."
    - scp -o StrictHostKeyChecking=no -r apache-config/ $VM_USER@$VM_HOST:/tmp/
    - echo "üîß Running storage optimization (preserving cache)..."
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "chmod +x /tmp/storage-troubleshoot.sh"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "bash /tmp/storage-troubleshoot.sh"
    - echo "üßπ Running selective cleanup and pre-build setup..."
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "bash /tmp/manage-storage.sh cleanup"
    - scp -o StrictHostKeyChecking=no scripts/pre-build-setup.sh $VM_USER@$VM_HOST:/tmp/
    - scp -o StrictHostKeyChecking=no scripts/diagnose-space-usage.sh $VM_USER@$VM_HOST:/tmp/
    - scp -o StrictHostKeyChecking=no scripts/test-buildkit-config.sh $VM_USER@$VM_HOST:/tmp/
    - echo "üîß Optimizing Docker volumes..."
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "chmod +x /tmp/fix-docker-volumes.sh"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "bash /tmp/fix-docker-volumes.sh"
    - echo "üìà Post-optimization storage status:"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h / | tail -1"
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h /srv/homedir | tail -1"
    - echo "üöÄ Proceeding with cache-optimized deployment..."
    - scp -o StrictHostKeyChecking=no scripts/deploy-to-vm.sh $VM_USER@$VM_HOST:/tmp/
    - scp -o StrictHostKeyChecking=no scripts/setup-directories.sh $VM_USER@$VM_HOST:/tmp/
    - ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "OPENAI_API_KEY='$OPENAI_API_KEY' VM_HOST='$VM_HOST' bash /tmp/deploy-to-vm.sh"
  environment:
    name: production
    url: http://$VM_HOST:3000
  only:
    - main 