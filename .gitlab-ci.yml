stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

before_script:
  - 'which ssh-agent || ( apk update && apk add openssh-client )'
  - eval $(ssh-agent -s)
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh

build:
  stage: build
  image: alpine:latest
  script:
    - echo "‚úÖ Build stage completed - ready for deployment"
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - echo "Deploying to production VM..."
    - echo "VM_HOST is set to: $VM_HOST"
    - echo "VM_USER is set to: $VM_USER"
    - echo "Testing SSH connection to $VM_USER@$VM_HOST..."
    - ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "echo 'SSH connection successful'"
    - |
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "export OPENAI_API_KEY='$OPENAI_API_KEY'; export VM_HOST='$VM_HOST'; bash -s" << 'EOF'
        set -e
        
        echo "üöÄ Starting deployment..."
        cd /home/vcm/mistral-enhancing-network-security-analysis
        
        # Check Docker installation and permissions
        if ! command -v docker &> /dev/null; then
          echo "‚ùå Docker not found. Installing Docker..."
          sudo apt update
          sudo apt install -y docker.io
          sudo usermod -aG docker vcm
          sudo systemctl enable docker
          sudo systemctl start docker
          echo "‚ö†Ô∏è  You may need to log out and back in for Docker group changes to take effect"
        fi
        
        # Check if user is in docker group
        if ! groups vcm | grep -q docker; then
          echo "‚ö†Ô∏è  User vcm not in docker group. Adding..."
          sudo usermod -aG docker vcm
          echo "‚ö†Ô∏è  You may need to log out and back in for group changes to take effect"
        fi
        
        # Pull latest changes
        echo "üì• Pulling latest changes..."
        git pull origin main
        
        # Create .env file if it doesn't exist
        if [ ! -f .env ]; then
          echo "üìù Creating .env file..."
          cat > .env << EOL
      OPENAI_API_KEY=$OPENAI_API_KEY
      OPENAI_API_BASE=https://litellm.oit.duke.edu

      MILVUS_HOST=milvus
      MILVUS_PORT=19530
      NEO4J_URI=bolt://neo4j:7687
      NEO4J_USER=neo4j
      NEO4J_PASSWORD=password123
      API_HOST=0.0.0.0
      API_PORT=8000
      NEXT_PUBLIC_API_URL=http://$VM_HOST:8000
      NEXT_PUBLIC_APP_URL=http://$VM_HOST:3000
      EOL
        fi
        
        # Check which Docker Compose command to use
        if command -v docker-compose &> /dev/null; then
          DOCKER_COMPOSE="docker-compose"
        elif docker compose version &> /dev/null; then
          DOCKER_COMPOSE="docker compose"
        else
          echo "‚ùå Docker Compose not found!"
          exit 1
        fi
        
        echo "Using Docker Compose command: $DOCKER_COMPOSE"
        
        # Stop existing services
        echo "üõë Stopping existing services..."
        $DOCKER_COMPOSE down || true
        
        # Clean up old images (optional)
        echo "üßπ Cleaning up old Docker images..."
        docker system prune -f || true
        
        # Build and start services
        echo "üî® Building and starting services..."
        $DOCKER_COMPOSE up -d --build
        
        # Wait for services to be ready
        echo "‚è≥ Waiting for services to start..."
        sleep 45
        
        # Check if services are running
        echo "üîç Checking service status..."
        $DOCKER_COMPOSE ps
        
        # Health checks
        echo "üè• Running health checks..."
        
        # Check API
        for i in {1..10}; do
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "‚úÖ API is healthy"
            break
          else
            echo "‚è≥ Waiting for API... ($i/10)"
            sleep 5
          fi
        done
        
        # Check Frontend
        for i in {1..10}; do
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "‚úÖ Frontend is healthy"
            break
          else
            echo "‚è≥ Waiting for Frontend... ($i/10)"
            sleep 5
          fi
        done
        
        # Check Neo4j
        if curl -f http://localhost:7474 > /dev/null 2>&1; then
          echo "‚úÖ Neo4j is healthy"
        else
          echo "‚ö†Ô∏è  Neo4j health check failed"
        fi
        
        # Check Milvus
        if curl -f http://localhost:9091/healthz > /dev/null 2>&1; then
          echo "‚úÖ Milvus is healthy"
        else
          echo "‚ö†Ô∏è  Milvus health check failed"
        fi
        
        echo "üéâ Deployment completed!"
        echo "Frontend: http://$VM_HOST:3000"
        echo "API: http://$VM_HOST:8000"
        echo "Neo4j: http://$VM_HOST:7474"
        echo "MinIO: http://$VM_HOST:9001"
      EOF
    - echo "‚úÖ Deployment completed successfully!"
  environment:
    name: production
    url: http://$VM_HOST:3000
  only:
    - main 