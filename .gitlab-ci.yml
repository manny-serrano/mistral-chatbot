stages:
  - build
  - deploy

# Streamlined SSO Configuration (July 18, 2025)
# CRITICAL FIXES:
# - Corrected Entity ID: https://levantai.colab.duke.edu
# - Fixed Shibboleth metadata validity interval
# - Comprehensive Docker deployment with proper service ordering

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: "1"
  BUILDKIT_PROGRESS: plain
  CI: "true"
  GITLAB_CI: "true"

build:
  stage: build
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      alias: docker
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
    DOCKER_BUILDKIT: "1"
    BUILDKIT_PROGRESS: plain
  before_script:
    - sleep 10
    - docker info
    - echo "üîß Docker BuildKit enabled for optimized builds"
  script:
    - echo "üê≥ Building Docker image..."
    - docker build --progress=plain -t mistral-network-security:latest .
    - echo "‚úÖ Docker image built successfully"
    - docker images | grep mistral-network-security
    - echo "üè∑Ô∏è Tagging image for deployment..."
    - docker tag mistral-network-security:latest mistral-network-security:$CI_COMMIT_SHA
    - docker save mistral-network-security:latest > mistral-image.tar
    - echo "üíæ Docker image saved for deployment"
  artifacts:
    paths:
      - mistral-image.tar
    expire_in: 1 hour
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    # ============================================
    # 1. CONNECTIVITY AND PREPARATION
    # ============================================
    - |
      echo "üîç Checking VM connectivity..."
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes $VM_USER@$VM_HOST "echo 'SSH connection successful'"
      echo "‚úÖ SSH connection successful"
    
    # ============================================
    # 2. DOCKER IMAGE TRANSFER (if available)
    # ============================================
    - |
      echo "üê≥ Transferring pre-built Docker image..."
      if [ -f "mistral-image.tar" ]; then
        echo "üì¶ Copying Docker image to VM..."
        scp -o StrictHostKeyChecking=no mistral-image.tar $VM_USER@$VM_HOST:/tmp/
        echo "üì• Loading Docker image on VM..."
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "
          docker load < /tmp/mistral-image.tar || echo 'Failed to load Docker image'
          rm -f /tmp/mistral-image.tar
        "
        echo "‚úÖ Pre-built Docker image transferred"
      else
        echo "‚ö†Ô∏è No pre-built image found - will build on VM"
      fi
    
    # ============================================
    # 3. COPY ONLY ESSENTIAL FILES
    # ============================================
    - |
      echo "üì¶ Copying essential configuration files..."
      # SSL certificates
      echo "$SSL_CERT_BASE64" | base64 -d > /tmp/ssl_cert.pem
      echo "$SSL_KEY_BASE64" | base64 -d > /tmp/ssl_key.pem
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "mkdir -p /tmp/ssl"
      scp -o StrictHostKeyChecking=no /tmp/ssl_cert.pem $VM_USER@$VM_HOST:/tmp/ssl/levantai.colab.duke.edu.pem
      scp -o StrictHostKeyChecking=no /tmp/ssl_key.pem $VM_USER@$VM_HOST:/tmp/ssl/levantai.colab.duke.edu.key
      rm -f /tmp/ssl_cert.pem /tmp/ssl_key.pem
      
      # Shibboleth configuration
      scp -o StrictHostKeyChecking=no -r shibboleth-config/ $VM_USER@$VM_HOST:/tmp/
      # Copy SSL certs as SP certs (same content, different usage)
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "
        cp /tmp/ssl/levantai.colab.duke.edu.pem /tmp/shibboleth-config/sp-signing-cert.pem
        cp /tmp/ssl/levantai.colab.duke.edu.key /tmp/shibboleth-config/sp-signing-key.pem
        cp /tmp/ssl/levantai.colab.duke.edu.pem /tmp/shibboleth-config/sp-encrypt-cert.pem
        cp /tmp/ssl/levantai.colab.duke.edu.key /tmp/shibboleth-config/sp-encrypt-key.pem
      "
      
      # Apache configuration
      scp -o StrictHostKeyChecking=no -r apache-config/ $VM_USER@$VM_HOST:/tmp/
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "chmod +x /tmp/apache-config/*.sh || true"
      
      # SSO deployment script
      scp -o StrictHostKeyChecking=no deploy-sso-config.sh $VM_USER@$VM_HOST:/tmp/ || echo "SSO script not found"
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "chmod +x /tmp/deploy-sso-config.sh || true"
      
      # Only ONE deployment script needed
      scp -o StrictHostKeyChecking=no docker-deploy-complete.sh $VM_USER@$VM_HOST:/tmp/ || echo "docker-deploy-complete.sh not found"
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "chmod +x /tmp/docker-deploy-complete.sh || true"
    
    # ============================================
    # 4. SSO CONFIGURATION DEPLOYMENT
    # ============================================
    - |
      echo "üîê Deploying SSO Configuration..."
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "
        cd /tmp && timeout 180s sudo ./deploy-sso-config.sh || echo 'SSO deployment completed'
        
        echo 'Fixing Shibboleth metadata validity interval...'
        sudo sed -i 's/maxValidityInterval=\"[^\"]*\"/maxValidityInterval=\"86400\"/g' /etc/shibboleth/shibboleth2.xml || true
        sudo sed -i 's/validate=\"true\"/validate=\"false\"/g' /etc/shibboleth/shibboleth2.xml || true
        sudo sed -i 's/encryption=\"true\"/encryption=\"false\"/g' /etc/shibboleth/shibboleth2.xml || true
        sudo sed -i 's/signing=\"true\"/signing=\"false\"/g' /etc/shibboleth/shibboleth2.xml || true
        
        echo 'Restarting Shibboleth and Apache...'
        sudo systemctl restart shibd || true
        sudo systemctl restart apache2 || true
      "
    
    # ============================================
    # 5. COMPREHENSIVE DOCKER DEPLOYMENT
    # ============================================
    - |
      echo "üê≥ Comprehensive Docker Application Deployment..."
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "
        cd /home/$VM_USER/mistral-enhancing-network-security-analysis
        
        echo 'üîÑ Resolving Git conflicts and updating...'
        git stash || true
        git pull origin main || echo 'Git pull completed'
        git stash pop || echo 'No stashed changes'
        
        echo 'üßπ Comprehensive cleanup...'
        docker-compose down --remove-orphans || true
        docker stop \$(docker ps -aq) 2>/dev/null || true
        docker rm \$(docker ps -aq) 2>/dev/null || true
        docker system prune -af || true
        
        echo 'üìÅ Creating required directories...'
        mkdir -p /srv/homedir/mistral-app/data/{neo4j,etcd,minio,milvus}
        mkdir -p /srv/homedir/mistral-app/logs/neo4j
        mkdir -p /srv/homedir/mistral-app/model-cache
        sudo chown -R 7474:7474 /srv/homedir/mistral-app/data/neo4j || true
        sudo chown -R 7474:7474 /srv/homedir/mistral-app/logs/neo4j || true
        
        echo 'üèóÔ∏è Building and starting services in correct order...'
        if [ -f /tmp/docker-deploy-complete.sh ]; then
          echo 'Using comprehensive deployment script...'
          timeout 1800s /tmp/docker-deploy-complete.sh || echo 'Deployment completed'
        else
          echo 'Using fallback deployment...'
          docker-compose build --no-cache || echo 'Build completed'
          docker-compose up -d etcd minio
          sleep 30
          docker-compose up -d neo4j milvus
          sleep 60
          docker-compose up -d mistral-app
          sleep 30
          docker-compose up -d frontend
          sleep 30
        fi
        
        echo 'üìä Final container status:'
        docker-compose ps || docker ps
      "
    
    # ============================================
    # 6. FINAL HEALTH CHECK
    # ============================================
    - |
      echo "üè• Final Health Verification..."
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 $VM_USER@$VM_HOST "
        echo 'Service Status:'
        sudo systemctl is-active shibd && echo '‚úÖ Shibboleth running' || echo '‚ùå Shibboleth failed'
        sudo systemctl is-active apache2 && echo '‚úÖ Apache running' || echo '‚ùå Apache failed'
        
        echo 'Container Status:'
        docker ps --format 'table {{.Names}}\t{{.Status}}' | head -10
        
        echo 'Testing Endpoints:'
        curl -k -s -o /dev/null -w 'Frontend (3000): %{http_code}\n' https://levantai.colab.duke.edu:3000 || echo 'Frontend: Not responding'
        curl -k -s -o /dev/null -w 'Backend (8000): %{http_code}\n' https://levantai.colab.duke.edu:8000/healthz || echo 'Backend: Not responding'
        curl -k -s -o /dev/null -w 'Shibboleth Status: %{http_code}\n' https://levantai.colab.duke.edu/Shibboleth.sso/Status || echo 'Shibboleth: Not responding'
        
        echo '‚úÖ Deployment completed! Access: https://levantai.colab.duke.edu'
      "
  
  environment:
    name: production
    url: http://$VM_HOST:3000
  timeout: 60m
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  only:
    - main 