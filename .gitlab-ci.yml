stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

build:
  stage: build
  image: alpine:latest
  script:
    - echo "‚úÖ Build stage completed - ready for deployment"
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - echo "üîç Checking VM connectivity..."
    - echo "VM_HOST: $VM_HOST"
    - echo "VM_USER: $VM_USER"
    - echo "Testing network connectivity to IP..."
    - |
      if ping -c 3 $VM_HOST; then
        echo "‚úÖ VM is reachable via ping"
      else
        echo "‚ùå VM is not reachable via ping"
        echo "üö® VM appears to be down or network issue"
        exit 1
      fi
    - echo "Testing SSH connectivity..."
    - |
      if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 -o BatchMode=yes $VM_USER@$VM_HOST "echo 'SSH connection successful'" 2>/dev/null; then
        echo "‚úÖ SSH connection successful"
        echo "Proceeding with deployment..."
        scp -o StrictHostKeyChecking=no scripts/deploy-to-vm.sh $VM_USER@$VM_HOST:/tmp/
        ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "export OPENAI_API_KEY='$OPENAI_API_KEY'; export VM_HOST='$VM_HOST'; bash /tmp/deploy-to-vm.sh"
        echo "‚úÖ Deployment completed successfully!"
      else
        echo "‚ùå SSH connection failed"
        echo "üö® VM is reachable but SSH service appears to be down"
        echo "üìã Manual intervention required:"
        echo "1. Access VM via Duke's web console"
        echo "2. Check SSH service: sudo systemctl status ssh"
        echo "3. Start SSH if needed: sudo systemctl start ssh"
        echo "4. Check firewall: sudo ufw status"
        echo "5. Allow SSH: sudo ufw allow ssh"
        echo "6. Re-run this pipeline after fixing SSH"
        exit 1
      fi
  environment:
    name: production
    url: http://$VM_HOST:3000
  only:
    - main
  allow_failure: true 