stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  # BuildKit will be automatically configured and used for optimized builds
  CI: "true"
  GITLAB_CI: "true"

build:
  stage: build
  image: alpine:latest
  script:
    - echo "‚úÖ Build stage completed - ready for deployment"
    - echo "üîß Docker build system will ensure BuildKit is available and configured"
  only:
    - main

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
  script:
    - |
      echo "üîç Checking VM connectivity..."
      echo "VM_HOST:$VM_HOST"
      echo "VM_USER:$VM_USER"
      echo "Testing network connectivity to IP..."
      ping -c 3 $VM_HOST || echo "‚ö†Ô∏è  Ping failed but continuing (might be blocked)"
      echo "Testing SSH connectivity..."
      ssh -o StrictHostKeyChecking=no -o ConnectTimeout=15 -o BatchMode=yes $VM_USER@$VM_HOST "echo 'SSH connection successful'"
      echo "‚úÖ SSH connection successful"
    - |
      echo "üåê Testing VM network connectivity..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "ping -c 3 8.8.8.8 || echo 'Network connectivity issue on VM'"
      echo "üîç Checking storage and system resources before deployment..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h /"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "free -h"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h /srv/homedir"
    - |
      echo "üóÇÔ∏è Pre-deployment cache optimization..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/docker-build-cache"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/pip-cache"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/npm-cache"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/docker-tmp"
    - |
      echo "üìÅ Creating Docker volume mount directories..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/neo4j"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/etcd"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/minio"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/data/milvus"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/logs/neo4j"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "mkdir -p /srv/homedir/mistral-app/model-cache"
    - |
      echo "üì¶ Copying essential scripts..."
      scp -o StrictHostKeyChecking=no scripts/manage-storage.sh $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no scripts/storage-troubleshoot.sh $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no scripts/check-health.sh $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no scripts/network-stability-check.sh $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no docker-build-retry.sh $VM_USER@$VM_HOST:/tmp/
    - |
      echo "üåê Running network stability check..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "chmod +x /tmp/network-stability-check.sh && /tmp/network-stability-check.sh || echo 'Network issues detected but continuing...'"
    - |
      echo "üîß Copying Apache configuration..."
      scp -o StrictHostKeyChecking=no -r apache-config/ $VM_USER@$VM_HOST:/tmp/
      echo "üîß Setting up Apache configuration scripts permissions..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "chmod +x /tmp/apache-config/*.sh || true"
    - |
      echo "üîê Deploying SSO Configuration Fixes..."
      echo "üìã Copying Shibboleth configuration files..."
      scp -o StrictHostKeyChecking=no -r shibboleth-config/ $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no -r debug-files/ $VM_USER@$VM_HOST:/tmp/
      echo "üìã Copying SSO deployment script..."
      scp -o StrictHostKeyChecking=no deploy-sso-config.sh $VM_USER@$VM_HOST:/tmp/ || echo "SSO script not found, skipping"
    - |
      echo "üîß Setting up SSO deployment script permissions..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "chmod +x /tmp/deploy-sso-config.sh || true"
      echo "‚öôÔ∏è Running SSO configuration deployment..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "cd /tmp && sudo /tmp/deploy-sso-config.sh || echo 'SSO deployment failed, continuing'"
    - |
      echo "üîÑ Restarting Shibboleth and Apache services..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "sudo systemctl restart shibd || true"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "sudo systemctl restart apache2 || true"
    - |
      echo "‚úÖ Verifying SSO service status..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "sudo systemctl is-active shibd && echo '‚úÖ Shibboleth daemon is running' || echo '‚ùå Shibboleth daemon failed'"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "sudo systemctl is-active apache2 && echo '‚úÖ Apache is running' || echo '‚ùå Apache failed'"
    - |
      echo "üîß Copying essential deployment scripts..."
      scp -o StrictHostKeyChecking=no scripts/setup-sudo-permissions.sh $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no scripts/auto-setup-permissions.sh $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no scripts/deploy-to-vm.sh $VM_USER@$VM_HOST:/tmp/
      scp -o StrictHostKeyChecking=no scripts/setup-directories.sh $VM_USER@$VM_HOST:/tmp/
    - |
      echo "üîë Setting up permissions for automatic Apache configuration..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "chmod +x /tmp/setup-sudo-permissions.sh /tmp/auto-setup-permissions.sh"
      echo "üîß Running storage optimization (preserving cache)..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "chmod +x /tmp/storage-troubleshoot.sh"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "bash /tmp/storage-troubleshoot.sh"
    - |
      echo "üßπ Running selective cleanup and pre-build setup..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "bash /tmp/manage-storage.sh cleanup"
      echo "üìà Post-optimization storage status:"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h / | tail -1"
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "df -h /srv/homedir | tail -1"
    - |
      echo "üöÄ Proceeding with cache-optimized deployment with network retry logic..."
      ssh -o StrictHostKeyChecking=no -o ServerAliveInterval=30 -o ServerAliveCountMax=3 $VM_USER@$VM_HOST "CI='true' GITLAB_CI='true' LIGHTWEIGHT_MODE='true' OPENAI_API_KEY='$OPENAI_API_KEY' VM_HOST='$VM_HOST' bash /tmp/deploy-to-vm.sh"
    - |
      echo "üè• Running comprehensive health check..."
      ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "cd /home/${VM_USER:-vcm}/mistral-enhancing-network-security-analysis && chmod +x /tmp/check-health.sh && /tmp/check-health.sh"
  environment:
    name: production
    url: http://$VM_HOST:3000
  timeout: 30m  # Increase timeout to 30 minutes for network issues
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  only:
    - main 